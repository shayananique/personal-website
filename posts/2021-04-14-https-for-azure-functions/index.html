<!doctype html><html lang=en><head><title>HTTPS with LetsEncrypt for Azure Functions :: Shayan Anique</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Setting up HTTPS with a proper certificate for Azure Functions should be straightforward and easy, but it's not. In this post I walk through one aspect of it that tripped me up."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://shayananique.com/posts/2021-04-14-https-for-azure-functions/><link rel=stylesheet href=https://shayananique.com/assets/style.css><link rel=stylesheet href=https://shayananique.com/assets/blue.css><link rel=apple-touch-icon href=https://shayananique.com/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=https://shayananique.com/img/favicon/blue.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="HTTPS with LetsEncrypt for Azure Functions"><meta property="og:description" content="Setting up HTTPS with a proper certificate for Azure Functions should be straightforward and easy, but it's not. In this post I walk through one aspect of it that tripped me up."><meta property="og:url" content="https://shayananique.com/posts/2021-04-14-https-for-azure-functions/"><meta property="og:site_name" content="Shayan Anique"><meta property="og:image" content="https://shayananique.com/img/favicon/blue.png"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2021-04-14 01:34:00 +0000 UTC"></head><body class=blue><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>Shayan Anique</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about>About</a></li><li><a href=/showcase>Showcase</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about>About</a></li><li><a href=/showcase>Showcase</a></li></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=https://shayananique.com/posts/2021-04-14-https-for-azure-functions/>HTTPS with LetsEncrypt for Azure Functions</a></h1><div class=post-meta><span class=post-date>2021-04-14</span></div><span class=post-tags>#<a href=https://shayananique.com/tags/azure/>azure</a>&nbsp;
#<a href=https://shayananique.com/tags/security/>security</a>&nbsp;</span><div class=post-content><div><p><em>UPDATE: there might be an easier way now. <a href=https://azure.microsoft.com/en-us/updates/public-preview-app-service-managed-certificates-now-supports-apex-domains/>App Service Managed Certificates now supports apex domains</a>. I&rsquo;ll give it a try and report back.</em></p><p>My friends, in an ideal world, it would be dead simple to set up a certificate for an Azure App Service. For example, GitHub Pages gets this right.</p><p><img src=https://raw.githubusercontent.com/shayananique/shayananique.com/main/assets/images/git_https_customdomain.png alt="Screen shot showing a checkbox for enforcing HTTPS" title="Could it be any easier?"></p><p>Look at that. A thing of beauty. Just click that checkbox and now your site is being served from HTTPS using a free certificate from LetsEncrypt. From an <em>apex domain</em> no less!</p><p>But to set up a custom apex domain with HTTPS for an Azure App Service is not so easy. It takes about a hundred steps. That&rsquo;s not that much of an exaggeration.</p><p>For my site, I use the wonderful <a href=https://github.com/ohadschn/letsencrypt-webapp-renewer>ohadschn/letsencrypt-webapp-renewer</a> tool. Like I said, it takes some time to set up manually, but once you do, it works great.</p><p>This post is not going to walk through that part. For that, I followed <a href=https://weblogs.asp.net/dixin/end-to-end-setup-free-ssl-certificate-to-secure-azure-web-app-with-https>this excellent guide by Dixin</a>. But be aware, the only constant is change and the Azure Portal embraces that credo. It&rsquo;s changed a lot since this guide was written, so the screenshots may not match exactly what you need to do today, but you should be able to figure it out. Even if you follow the guide, it may be worth reading the README in the original repository.</p><h2 id=azure-functions>Azure Functions<a href=#azure-functions class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Now suppose you want to serve an Azure Function using HTTPS and a LetsEncrypt certificate. To clarify, I&rsquo;m not talking about using an Azure Function to run <code>letsencrypt-webapp-renewer</code> on a schedule. In fact, if you search Azure Functions and <code>letsencrypt-webapp-renewer</code>, almost all the results are about that. No, I&rsquo;m talking about being able to access your function via <code>https://your-custom-domain/api/your-function</code>.</p><p>Since an Azure Function is an App Service under the hood, wouldn&rsquo;t the instructions I mentioned earlier just work?</p><p>You wish. No, Azure Functions are <em>SPECIAL!</em></p><p>See, the problem is that LetsEncrypt needs to be able to verify that the domain is under your control. So it&rsquo;s going to make a <code>GET</code> request to <code>http://your-custom-domain/.well-known/acme-challenge/{some-code}</code> and expect a certain response. By default, all requests to Azure Functions have the <code>/api</code> prefix. So we need to do a little magic to get this to work. We need to create a proxy!</p><p>Fortunately, there&rsquo;s <a href=https://github.com/sjkp/letsencrypt-siteextension/wiki/Azure-Functions-Support>a guide for that</a>. Unfortunately, it&rsquo;s a bit outdated. Also, it doesn&rsquo;t work if your function is controlled via source control. For example, my functions are in GitHub so the Azure Portal won&rsquo;t let me create a proxy in the Azure Portal.</p><p>And here is where I come to save the day. This is what I did to fix the situation.</p><p>First, add a <code>proxies.json</code> file to your function directory. This is in the same place where your <code>hosts.json</code> file is located. In your project file, make sure this file is copied to the output directory. I forgot the first time I added this file and it filled me with regret as nothing worked.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;None</span> <span style=color:#a6e22e>Update=</span><span style=color:#e6db74>&#34;proxies.json&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;CopyToOutputDirectory&gt;</span>PreserveNewest<span style=color:#f92672>&lt;/CopyToOutputDirectory&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/None&gt;</span>
</span></span></code></pre></div><p>Your <code>proxies.json</code> file should look something like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;$schema&#34;</span>: <span style=color:#e6db74>&#34;http://json.schemastore.org/proxies&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;proxies&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;letsencrypt-proxy&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;matchCondition&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;route&#34;</span>: <span style=color:#e6db74>&#34;/.well-known/acme-challenge/{*rest}&#34;</span>
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;backendUri&#34;</span>: <span style=color:#e6db74>&#34;https://%WEBSITE_HOSTNAME%/api/letsencrypt/{rest}&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This proxy will route requests to <code>https://your-custom-domain/.well-known/acme-challenge/{*rest}</code> to <code>https://your-custom-domain/api/letsencrypt/{rest}</code>.</p><p>Now, you need to add a function class to handle that request.</p><p>Here&rsquo;s the code for mine, adapted from the guide I mentioned.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>using</span> System.IO;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> System.Net;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> System.Net.Http;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> System.Text;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> System.Threading.Tasks;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> Microsoft.AspNetCore.Http;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> Microsoft.Azure.WebJobs;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> Microsoft.Azure.WebJobs.Extensions.Http;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> Microsoft.Extensions.Logging;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>namespace</span> Serious.Abbot.Functions
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AcmeChallengeFunction</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span><span style=color:#a6e22e>        [FunctionName(&#34;AcmeChallenge&#34;)]</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>async</span> Task&lt;HttpResponseMessage&gt; Run(
</span></span><span style=display:flex><span><span style=color:#a6e22e>            [HttpTrigger(AuthorizationLevel.Anonymous, Route = &#34;letsencrypt/{*rest}&#34;)]</span>
</span></span><span style=display:flex><span>            HttpRequest req,
</span></span><span style=display:flex><span>            ILogger log,
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>string</span> rest)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            log.LogInformation(<span style=color:#e6db74>$&#34;Acme challenge requested with {req.Method}.&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>var</span> content = <span style=color:#66d9ef>await</span> File.ReadAllTextAsync(<span style=color:#e6db74>$@&#34;D:\home\site\wwwroot\.well-known\acme-challenge\{rest}&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>var</span> resp = <span style=color:#66d9ef>new</span> HttpResponseMessage(HttpStatusCode.OK)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                Content = <span style=color:#66d9ef>new</span> StringContent(content, Encoding.UTF8, <span style=color:#e6db74>&#34;text/plain&#34;</span>)
</span></span><span style=display:flex><span>            };
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> resp;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Commit that, deploy it, and try it out! Now, hopefully the next person that runs into this will find my blog post and not the hundreds of other irrelevant posts, and know what to do.</p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button next"><a href=https://shayananique.com/posts/2019-07-29-query-filter-by-interface/><span class=button__text>Global Query Filters for Interfaces</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2022 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=https://shayananique.com/assets/main.js></script>
<script src=https://shayananique.com/assets/prism.js></script></div></body></html>